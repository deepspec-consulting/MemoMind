{% extends 'base.html' %}

{% block extra_head %}
<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
        animation: fadeIn 0.5s ease-out;
    }
</style>
{% endblock %}

{% block content %}
    <div class="chat-container">
    {% for note in notes %}
        <div class="chat-message {% if note[3] %}voice-note{% else %}text-note{% endif %}">
            <div class="emoji-avatar">
                {{ note[4] | safe }}
            </div>
            <div class="message-content">
                {% if note[3] %}
                    <div class="audio-container">
                        <audio controls>
                            <source src="{{ url_for('static', filename='audio/' + note[2]) }}" type="audio/wav">
                            Your browser does not support the audio element.
                        </audio>
                        <div class="note-actions">
                            <a href="{{ url_for('edit_note', id=note[0]) }}" title="Edit"><span class="material-icons">edit</span></a>
                            <a href="{{ url_for('delete_note', id=note[0]) }}" onclick="return confirm('Are you sure you want to delete this note?');" title="Delete"><span class="material-icons">delete</span></a>
                        </div>
                    </div>
                {% else %}
                    <div class="text-container">
                        <p class="note-content">{{ note[2] }}</p>
                        <div class="note-actions">
                            <a href="{{ url_for('edit_note', id=note[0]) }}" title="Edit"><span class="material-icons">edit</span></a>
                            <a href="{{ url_for('delete_note', id=note[0]) }}" onclick="return confirm('Are you sure you want to delete this note?');" title="Delete"><span class="material-icons">delete</span></a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endfor %}
    </div>

    <div class="input-container">
        <input type="text" id="noteInput" placeholder="Type a note...">
        <button id="micButton" class="mic-button">
            <span class="material-icons">mic</span>
        </button>
    </div>
{% endblock %}

{% block scripts %}
<script>
    const noteInput = document.getElementById('noteInput');
    const micButton = document.getElementById('micButton');
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    noteInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const content = noteInput.value.trim();
            if (content) {
                addTextNote(content);
                noteInput.value = '';
            }
        }
    });

    micButton.addEventListener('click', toggleRecording);

    function addTextNote(content) {
        fetch('{{ url_for("add_note") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `title=${encodeURIComponent(content.substring(0, 30))}&content=${encodeURIComponent(content)}`
        }).then(response => {
            if (response.ok) {
                return response.json();
            }
        }).then(data => {
            if (data) {
                addNoteToDOM(data);
            }
        });
    }

    function addNoteToDOM(note) {
        const chatContainer = document.querySelector('.chat-container');
        const noteElement = document.createElement('div');
        noteElement.className = `chat-message text-note fade-in`;
        noteElement.innerHTML = `
            <div class="emoji-avatar">
                ${note.emoji}
            </div>
            <div class="message-content">
                <div class="text-container">
                    <p class="note-content">${note.content}</p>
                    <div class="note-actions">
                        <a href="/edit/${note.id}" title="Edit"><span class="material-icons">edit</span></a>
                        <a href="/delete/${note.id}" onclick="return confirm('Are you sure you want to delete this note?');" title="Delete"><span class="material-icons">delete</span></a>
                    </div>
                </div>
            </div>
        `;
        chatContainer.appendChild(noteElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function saveVoiceNote(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.wav');
        fetch('{{ url_for("add_voice_note") }}', {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                return response.json();
            }
        }).then(data => {
            if (data) {
                addVoiceNoteToDOM(data);
            }
        });
    }

    function addVoiceNoteToDOM(note) {
        const chatContainer = document.querySelector('.chat-container');
        const noteElement = document.createElement('div');
        noteElement.className = `chat-message voice-note fade-in`;
        noteElement.innerHTML = `
            <div class="emoji-avatar">
                ${note.emoji}
            </div>
            <div class="message-content">
                <div class="audio-container">
                    <audio controls>
                        <source src="/static/audio/${note.content}" type="audio/wav">
                        Your browser does not support the audio element.
                    </audio>
                    <div class="note-actions">
                        <a href="/edit/${note.id}" title="Edit"><span class="material-icons">edit</span></a>
                        <a href="/delete/${note.id}" onclick="return confirm('Are you sure you want to delete this note?');" title="Delete"><span class="material-icons">delete</span></a>
                    </div>
                </div>
            </div>
        `;
        chatContainer.appendChild(noteElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
</script>
{% endblock %}