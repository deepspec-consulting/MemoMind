{% extends 'base.html' %}

{% block content %}
    <div class="chat-container">
    {% for note in notes %}
        <div class="chat-message {% if note[3] %}voice-note{% else %}text-note{% endif %}">
            <div class="emoji-avatar">
                {{ note[4] }}
            </div>
            <div class="message-content">
                {% if note[3] %}
                    <div class="audio-container">
                        <audio controls>
                            <source src="{{ url_for('static', filename='audio/' + note[2]) }}" type="audio/wav">
                            Your browser does not support the audio element.
                        </audio>
                        <div class="note-actions">
                            <a href="{{ url_for('edit_note', id=note[0]) }}" title="Edit"><span class="material-icons">edit</span></a>
                            <a href="{{ url_for('delete_note', id=note[0]) }}" onclick="return confirm('Are you sure you want to delete this note?');" title="Delete"><span class="material-icons">delete</span></a>
                        </div>
                    </div>
                {% else %}
                    <div class="text-container">
                        <p class="note-content">{{ note[2] }}</p>
                        <div class="note-actions">
                            <a href="{{ url_for('edit_note', id=note[0]) }}" title="Edit"><span class="material-icons">edit</span></a>
                            <a href="{{ url_for('delete_note', id=note[0]) }}" onclick="return confirm('Are you sure you want to delete this note?');" title="Delete"><span class="material-icons">delete</span></a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endfor %}
    </div>

    <div class="input-container">
        <input type="text" id="noteInput" placeholder="Type a note...">
        <button id="micButton" class="mic-button">
            <span class="material-icons">mic</span>
        </button>
    </div>
{% endblock %}

{% block scripts %}
<script>
    const noteInput = document.getElementById('noteInput');
    const micButton = document.getElementById('micButton');
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    noteInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const content = noteInput.value.trim();
            if (content) {
                addTextNote(content);
                noteInput.value = '';
            }
        }
    });

    micButton.addEventListener('click', toggleRecording);

    function addTextNote(content) {
        fetch('{{ url_for("add_note") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `title=${encodeURIComponent(content.substring(0, 30))}&content=${encodeURIComponent(content)}`
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            }
        });
    }

    async function toggleRecording() {
        if (!isRecording) {
            try {
                audioChunks = [];
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    saveVoiceNote(audioBlob);
                };
                mediaRecorder.start();
                isRecording = true;
                micButton.classList.add('recording');
                micButton.querySelector('.material-icons').textContent = 'stop';
            } catch (err) {
                console.error("Error accessing the microphone", err);
                alert("Error accessing the microphone. Please make sure you've granted the necessary permissions.");
            }
        } else {
            mediaRecorder.stop();
            isRecording = false;
            micButton.classList.remove('recording');
            micButton.querySelector('.material-icons').textContent = 'mic';
        }
    }

    function saveVoiceNote(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.wav');
        fetch('{{ url_for("add_voice_note") }}', {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            }
        });
    }
</script>
{% endblock %}